#!/usr/bin/env bash
set -eu -o pipefail

# check if all necessary files are present 
if [[ ! -e app.splog || ! -e db.url ]]; then
    error "Not inside a Spannerlog application: app.splog and db.url should be all present in a parent directory"
fi

# delete old target directory and create a new one
rm -rf target
mkdir target
mkdir target/udf

# collect schemata
schema=()
ln -s "../db.url" "target/db.url"
if [[ -d edb ]]; then
	ln -s "../edb" "target/input"
	(extract-edb-schema.py edb) > target/edb.schema.json
	schema+=(-edb target/edb.schema.json)
fi
if [[ -d ief ]]; then
	(extract-ief-schema.py ief) > target/ief.schema.json
	schema+=(-ief target/ief.schema.json)
fi

# compile spannerlog program
cmd="java -jar $SPLOG_HOME/spannerlog-1.0-SNAPSHOT.jar -program app.splog ${schema[*]:-}"
($cmd 2>&1>&3 | print-error) 3> target/splog.json

(compile-to-ddlog.py target/splog.json) > target/app.ddlog 			# generate ddlog program
(compile-rgx-to-sql.py target/splog.json) > target/rgx.sql 			# compile regex formulas into an sql script
(compile-exec-plan-to-bash.py target/splog.json) > target/run.sh 	# generate execution script

cd target
chmod -R 777 .* 
deepdive compile 							# compile ddlog program
deepdive db init 							# initialize databases
deepdive do process/init/app > /dev/null	# initialize ddlog app

# add procedural code to postgres
url=$(eval echo "$(cat db.url)")
db=${url##*/}
psql -d $db -c "CREATE EXTENSION plpythonu"
echo "Importing built-in IEFs"
psql -d $db -f ../../installation/lib/ner.sql # always?
if [[ -e rgx.sql ]]; then
	echo "Importing auto-generated regex formulas"
    psql -d $db -f rgx.sql
fi

cd ..

# Compilation completed. Ready to run.
