#!/usr/bin/env bash
set -eu

if [[ ! -e app.splog || ! -e db.url ]]; then
    error "Not inside a Spannerlog application: app.splog and db.url should be all present in a parent directory"
fi

# delete old target directory and create a new one
rm -rf target
mkdir target

# create soft links
ln -s "../db.url" "target/db.url"
[[ -d input ]] && ln -s "../input" "target/input"
[[ -d udf ]] && (compile-udf-dir.py) > target/schema.json

exit

# compile spannerlog program
(java -jar $SPLOG_HOME/spannerlog-1.0-SNAPSHOT.jar -compile app.splog) > target/app.ddlog
if [ $? -eq 0 ]; then
   cd target
   deepdive compile
   cd ..
fi

